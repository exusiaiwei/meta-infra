# ================================================================================================
# meta-infra - Mise 配置文件
# ================================================================================================
# 用途：定义项目级别的任务和工具版本
# Mise 是整个项目的核心编排工具，负责：
#   1. 任务编排 (Task Runner)
#   2. 工具版本管理 (类似 Nvm/Pyenv/Rbenv)
#   3. 环境变量管理
#
# 文档：https://mise.jdx.dev/
# ================================================================================================

# ========================================
# 工具版本管理
# ========================================
# 定义项目依赖的工具及其版本
# 当进入此目录时，Mise 会自动激活这些工具

[tools]
# ========================================
# 核心语言运行时
# ========================================
python = "3.12"           # Python 解释器（固定版本，稳定）
node = "lts"              # Node.js LTS 版本（用于文档系统和 npm 工具）

# ========================================
# 文档与排版工具
# ========================================
# 注意：Quarto、Typst 等复杂工具改用 Winget 安装
# winget install Posit.Quarto
# winget install Typst.Typst

# ========================================
# 数据处理工具
# ========================================
jq = "latest"             # JSON 查询和处理
yq = "latest"             # YAML/XML 查询和处理
ripgrep = "latest"        # 快速文本搜索（rg 命令）

# ========================================
# Python 包管理
# ========================================
pixi = "latest"           # 现代 Python/Conda 包管理器

# ========================================
# AI CLI 工具（通过 npm 安装）
# ========================================
"npm:@anthropic-ai/claude-code" = "latest"   # Claude Code CLI (官方)
"npm:@google/gemini-cli" = "latest"          # Gemini CLI (官方)

# ========================================
# 环境变量
# ========================================
[env]
# 设置项目级别的环境变量
# PAGER = "cat"           # 禁用分页器
# EDITOR = "code"         # 设置默认编辑器

# ========================================
# 核心任务定义
# ========================================
# 架构设计：
#   PowerShell (BIOS层) → Mise (OS层) → PowerShell (应用层)
#   注：已从 Nushell 迁移回 PowerShell 以提高稳定性和兼容性

# ========== Bootstrap 任务 ==========

[tasks.bootstrap]
description = "【完整安装向导】交互式安装流程 (从 init.ps1 调用)"
run = "powershell -ExecutionPolicy Bypass -File scripts/install.ps1"

[tasks."bootstrap:quick"]
description = "【快速安装】仅安装核心+标准层"
run = """
winget configure manifests/core/base.yaml --accept-configuration-agreements
Get-ChildItem manifests/standard/*.yaml | ForEach-Object { winget configure $_.Name --accept-configuration-agreements }
"""

[tasks."bootstrap:minimal"]
description = "【最小安装】仅安装核心层"
run = "winget configure manifests/core/base.yaml --accept-configuration-agreements"

# ========== 初始化任务 ==========

[tasks.init]
description = "【阶段 2】初始化所有配置（在 Winget DSC 完成后运行）"
run = "powershell -ExecutionPolicy Bypass -File scripts/maintenance.ps1 -Task init"

[tasks.verify]
description = "验证所有依赖工具是否已正确安装"
run = "powershell -ExecutionPolicy Bypass -File scripts/verify-install.ps1"

# ========== 设置任务 ==========

[tasks."setup:nushell"]
description = "配置 Nushell"
run = "powershell -ExecutionPolicy Bypass -File scripts/setup-config.ps1 -Target nushell"

[tasks."setup:starship"]
description = "配置 Starship 提示符"
run = "powershell -ExecutionPolicy Bypass -File scripts/setup-config.ps1 -Target starship"

[tasks."setup:terminal"]
description = "配置 Windows Terminal"
run = "powershell -ExecutionPolicy Bypass -File scripts/setup-config.ps1 -Target terminal"

# ========== 维护任务 ==========

[tasks.update]
description = "更新所有工具和包"
run = "powershell -ExecutionPolicy Bypass -File scripts/maintenance.ps1 -Task update"

[tasks.status]
description = "显示系统状态和已安装工具"
run = "powershell -ExecutionPolicy Bypass -File scripts/maintenance.ps1 -Task status"

[tasks.clean]
description = "清理临时文件和缓存"
run = "powershell -ExecutionPolicy Bypass -File scripts/maintenance.ps1 -Task clean"

# ========== 文档任务 ==========

[tasks."docs:init"]
description = "初始化 Rspress 文档项目"
run = """
if (!(Test-Path docs/package.json)) {
    cd docs
    npm create rspress@latest
    cd ..
    Write-Host "✅ Rspress 初始化完成"
} else {
    Write-Host "ℹ️  文档项目已存在"
}
"""

[tasks."docs:dev"]
description = "启动文档开发服务器"
run = "cd docs && npm run dev"
depends = ["docs:install"]

[tasks."docs:build"]
description = "构建文档静态站点"
run = "cd docs && npm run build"
depends = ["docs:install"]

[tasks."docs:install"]
description = "安装文档项目依赖"
run = """
if (Test-Path docs/package.json) {
    cd docs
    npm install
    cd ..
} else {
    Write-Host "❌ 文档项目未初始化，请先运行: mise run docs:init"
    exit 1
}
"""

# ========================================
# 任务别名
# ========================================
[alias]
# 常用任务的简短别名
i = "init"
s = "status"
u = "update"
c = "clean"
v = "verify"
