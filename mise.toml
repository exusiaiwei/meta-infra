# ================================================================================================
# meta-infra - Mise é…ç½®æ–‡ä»¶
# ================================================================================================
# ç”¨é€”ï¼šå®šä¹‰é¡¹ç›®çº§åˆ«çš„ä»»åŠ¡å’Œå·¥å…·ç‰ˆæœ¬
# Mise æ˜¯æ•´ä¸ªé¡¹ç›®çš„æ ¸å¿ƒç¼–æ’å·¥å…·ï¼Œè´Ÿè´£ï¼š
#   1. ä»»åŠ¡ç¼–æ’ (Task Runner)
#   2. å·¥å…·ç‰ˆæœ¬ç®¡ç† (ç±»ä¼¼ Nvm/Pyenv/Rbenv)
#   3. ç¯å¢ƒå˜é‡ç®¡ç†
#
# æ–‡æ¡£ï¼šhttps://mise.jdx.dev/
# ================================================================================================

# ========================================
# å·¥å…·ç‰ˆæœ¬ç®¡ç†
# ========================================
# å®šä¹‰é¡¹ç›®ä¾èµ–çš„å·¥å…·åŠå…¶ç‰ˆæœ¬
# å½“è¿›å…¥æ­¤ç›®å½•æ—¶ï¼ŒMise ä¼šè‡ªåŠ¨æ¿€æ´»è¿™äº›å·¥å…·

[tools]
# ========================================
# æ ¸å¿ƒè¯­è¨€è¿è¡Œæ—¶
# ========================================
python = "3.12"           # Python è§£é‡Šå™¨ï¼ˆå›ºå®šç‰ˆæœ¬ï¼Œç¨³å®šï¼‰
node = "lts"              # Node.js LTS ç‰ˆæœ¬ï¼ˆç”¨äºæ–‡æ¡£ç³»ç»Ÿå’Œ npm å·¥å…·ï¼‰

# ========================================
# æ–‡æ¡£ä¸æ’ç‰ˆå·¥å…·
# ========================================
# æ³¨æ„ï¼šQuartoã€Typst ç­‰å¤æ‚å·¥å…·æ”¹ç”¨ Winget å®‰è£…
# winget install Posit.Quarto
# winget install Typst.Typst

# ========================================
# æ•°æ®å¤„ç†å·¥å…·
# ========================================
jq = "latest"             # JSON æŸ¥è¯¢å’Œå¤„ç†
yq = "latest"             # YAML/XML æŸ¥è¯¢å’Œå¤„ç†
ripgrep = "latest"        # å¿«é€Ÿæ–‡æœ¬æœç´¢ï¼ˆrg å‘½ä»¤ï¼‰

# ========================================
# Python åŒ…ç®¡ç†
# ========================================
pixi = "latest"           # ç°ä»£ Python/Conda åŒ…ç®¡ç†å™¨

# ========================================
# AI CLI å·¥å…·ï¼ˆé€šè¿‡ npm å®‰è£…ï¼‰
# ========================================
"npm:@anthropic-ai/claude-code" = "latest"   # Claude Code CLI (å®˜æ–¹)
"npm:@google/gemini-cli" = "latest"          # Gemini CLI (å®˜æ–¹)

# ========================================
# (å¯é€‰) å…¶ä»–è¯­è¨€è¿è¡Œæ—¶
# ========================================
# rust = "latest"         # Rust å·¥å…·é“¾
# go = "latest"           # Go ç¼–è¯‘å™¨

# ========================================
# ç¯å¢ƒå˜é‡
# ========================================
[env]
# è®¾ç½®é¡¹ç›®çº§åˆ«çš„ç¯å¢ƒå˜é‡
# PAGER = "cat"           # ç¦ç”¨åˆ†é¡µå™¨
# EDITOR = "code"         # è®¾ç½®é»˜è®¤ç¼–è¾‘å™¨

# ========================================
# æ ¸å¿ƒä»»åŠ¡å®šä¹‰
# ========================================
# æ¶æ„è®¾è®¡ï¼š
#   PowerShell (BIOSå±‚) â†’ Mise (OSå±‚) â†’ Nushell (åº”ç”¨å±‚)

# ========== Bootstrap ä»»åŠ¡ï¼ˆä» PowerShell å¼•å¯¼å¯åŠ¨ï¼‰==========

[tasks.bootstrap]
description = "ã€å®Œæ•´å®‰è£…å‘å¯¼ã€‘äº¤äº’å¼å®‰è£…æµç¨‹ (ä» init.ps1 è°ƒç”¨)"
run = "nu scripts/bootstrap.nu"

[tasks."bootstrap:quick"]
description = "ã€å¿«é€Ÿå®‰è£…ã€‘ä»…å®‰è£…æ ¸å¿ƒ+æ ‡å‡†å±‚"
run = """
winget configure manifests/core/base.yaml --accept-configuration-agreements
ls manifests/standard/*.yaml | each { |file| winget configure $file.name --accept-configuration-agreements }
"""

[tasks."bootstrap:minimal"]
description = "ã€æœ€å°å®‰è£…ã€‘ä»…å®‰è£…æ ¸å¿ƒå±‚"
run = "winget configure manifests/core/base.yaml --accept-configuration-agreements"

# ========== åˆå§‹åŒ–ä»»åŠ¡ ==========

[tasks.init]
description = "ã€é˜¶æ®µ 2ã€‘åˆå§‹åŒ–æ‰€æœ‰é…ç½®ï¼ˆåœ¨ Winget DSC å®Œæˆåè¿è¡Œï¼‰"
run = """
nu -c '
    print ""
    print "ğŸš€ å¼€å§‹åˆå§‹åŒ– meta-infra é…ç½®ç³»ç»Ÿ..."
    print "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    print ""

    # 1. éªŒè¯ä¾èµ–
    print "ğŸ“‹ æ­¥éª¤ 1/4: éªŒè¯ä¾èµ–å·¥å…·..."
    mise run verify
    print ""

    # 2. é…ç½® Nushell
    print "âš™ï¸  æ­¥éª¤ 2/4: é…ç½® Nushell..."
    mise run setup:nushell
    print ""

    # 3. é…ç½® Starship
    print "âš™ï¸  æ­¥éª¤ 3/4: é…ç½® Starship..."
    mise run setup:starship
    print ""

    # 4. é…ç½® Windows Terminal (å¯é€‰)
    print "âš™ï¸  æ­¥éª¤ 4/4: é…ç½® Windows Terminal..."
    mise run setup:terminal
    print ""

    print "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    print "âœ… åˆå§‹åŒ–å®Œæˆï¼"
    print ""
    print "ğŸ¯ ä¸‹ä¸€æ­¥ï¼š"
    print "   1. é‡å¯ç»ˆç«¯ä»¥åº”ç”¨æ–°é…ç½®"
    print "   2. è¿è¡Œ \\"nu\\" è¿›å…¥ Nushell"
    print "   3. è¿è¡Œ \\"mise run status\\" æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€"
    print ""
'
"""

[tasks.verify]
description = "éªŒè¯æ‰€æœ‰ä¾èµ–å·¥å…·æ˜¯å¦å·²æ­£ç¡®å®‰è£…"
run = """
nu scripts/verify-install.nu
"""

# ========== è®¾ç½®ä»»åŠ¡ ==========

[tasks."setup:nushell"]
description = "é…ç½® Nushellï¼ˆå¤åˆ¶é…ç½®æ–‡ä»¶åˆ°ç”¨æˆ·ç›®å½•ï¼‰"
run = """
nu -c '
    print "âš™ï¸  é…ç½® Nushell..."

    # åˆ›å»ºé…ç½®ç›®å½•
    let config_dir = ($env.APPDATA | path join "nushell")
    mkdir $config_dir

    # å¤åˆ¶é…ç½®æ–‡ä»¶ï¼ˆæš‚æ—¶ç›´æ¥å¤åˆ¶ï¼Œæœªæ¥ä½¿ç”¨ Chezmoiï¼‰
    if ("dotfiles/config.nu" | path exists) {
        cp dotfiles/config.nu $config_dir
        print "  âœ“ å·²å¤åˆ¶ config.nu"
    } else {
        print "  âš ï¸  config.nu ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
    }

    if ("dotfiles/env.nu" | path exists) {
        cp dotfiles/env.nu $config_dir
        print "  âœ“ å·²å¤åˆ¶ env.nu"
    } else {
        print "  âš ï¸  env.nu ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
    }

    print "âœ… Nushell é…ç½®å®Œæˆ"
'
"""

[tasks."setup:starship"]
description = "é…ç½® Starship æç¤ºç¬¦"
run = """
nu -c '
    print "âš™ï¸  é…ç½® Starship..."

    # åˆ›å»ºé…ç½®ç›®å½•
    let config_dir = ($env.USERPROFILE | path join ".config")
    mkdir $config_dir

    # å¤åˆ¶ Starship é…ç½®
    if ("dotfiles/starship.toml" | path exists) {
        cp dotfiles/starship.toml ($config_dir | path join "starship.toml")
        print "  âœ“ å·²å¤åˆ¶ starship.toml"
    } else {
        print "  âš ï¸  starship.toml ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
    }

    print "âœ… Starship é…ç½®å®Œæˆ"
'
"""

[tasks."setup:terminal"]
description = "é…ç½® Windows Terminalï¼ˆå¯é€‰ï¼‰"
run = """
nu -c '
    print "âš™ï¸  é…ç½® Windows Terminal..."

    let terminal_dir = ($env.LOCALAPPDATA | path join "Packages" "Microsoft.WindowsTerminal_8wekyb3d8bbwe" "LocalState")

    if ($terminal_dir | path exists) {
        if ("dotfiles/windows-terminal-settings.json" | path exists) {
            cp dotfiles/windows-terminal-settings.json ($terminal_dir | path join "settings.json")
            print "  âœ“ å·²é…ç½® Windows Terminal"
        } else {
            print "  â„¹ï¸  æœªæ‰¾åˆ° Windows Terminal é…ç½®æ–‡ä»¶ï¼Œè·³è¿‡"
        }
    } else {
        print "  â„¹ï¸  æœªå®‰è£… Windows Terminalï¼Œè·³è¿‡é…ç½®"
    }

    print "âœ… Windows Terminal é…ç½®å®Œæˆ"
'
"""

# ========== ç»´æŠ¤ä»»åŠ¡ ==========

[tasks.update]
description = "æ›´æ–°æ‰€æœ‰å·¥å…·å’ŒåŒ…"
run = """
nu -c '
    print "ğŸ“¦ æ›´æ–°ç³»ç»Ÿ..."
    print ""

    # æ›´æ–° Winget åŒ…
    print "1ï¸âƒ£  æ›´æ–° Winget åŒ…..."
    winget upgrade --all --silent
    print ""

    # æ›´æ–° Mise å·¥å…·
    print "2ï¸âƒ£  æ›´æ–° Mise å·¥å…·..."
    mise upgrade
    print ""

    # æ›´æ–°æ–‡æ¡£ä¾èµ–ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if ("docs/package.json" | path exists) {
        print "3ï¸âƒ£  æ›´æ–°æ–‡æ¡£ä¾èµ–..."
        cd docs
        npm update
        cd ..
    }

    print "âœ… æ‰€æœ‰å·¥å…·å·²æ›´æ–°ï¼"
'
"""

[tasks.status]
description = "æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€å’Œå·²å®‰è£…å·¥å…·"
run = """
nu -c '
    print ""
    print "ğŸ“Š meta-infra ç³»ç»ŸçŠ¶æ€"
    print "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    print ""

    print "ğŸ› ï¸  æ ¸å¿ƒå·¥å…·ç‰ˆæœ¬ï¼š"
    print $"  Git:      (git --version | str trim)"
    print $"  Mise:     (mise --version | str trim)"
    print $"  Nushell:  (nu --version | str trim)"
    print $"  Starship: (starship --version | str trim)"
    print ""

    print "ğŸ“¦ Mise ç®¡ç†çš„å·¥å…·ï¼š"
    mise list
    print ""

    print "ğŸ’» ç³»ç»Ÿä¿¡æ¯ï¼š"
    print $"  æ¶æ„:     (sys host | get arch)"
    print $"  æ“ä½œç³»ç»Ÿ: (sys host | get name) (sys host | get os_version)"
    print ""
'
"""

[tasks.clean]
description = "æ¸…ç†ä¸´æ—¶æ–‡ä»¶å’Œç¼“å­˜"
run = """
nu -c '
    print "ğŸ§¹ æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶..."

    # æ¸…ç† Mise ç¼“å­˜
    print "  æ¸…ç† Mise ç¼“å­˜..."
    mise cache clear

    # æ¸…ç†æ–‡æ¡£æ„å»ºäº§ç‰©
    if ("docs/dist" | path exists) {
        print "  æ¸…ç†æ–‡æ¡£æ„å»ºäº§ç‰©..."
        rm -rf docs/dist
    }

    if ("docs/node_modules" | path exists) {
        print "  æ¸…ç† Node æ¨¡å—..."
        rm -rf docs/node_modules
    }

    print "âœ… æ¸…ç†å®Œæˆï¼"
'
"""

# ========== æ–‡æ¡£ä»»åŠ¡ ==========

[tasks."docs:init"]
description = "åˆå§‹åŒ– Rspress æ–‡æ¡£é¡¹ç›®"
run = """
nu -c '
    print "ğŸ“š åˆå§‹åŒ– Rspress æ–‡æ¡£é¡¹ç›®..."

    if not ("docs/package.json" | path exists) {
        cd docs
        npm create rspress@latest
        cd ..
        print "âœ… Rspress åˆå§‹åŒ–å®Œæˆ"
    } else {
        print "â„¹ï¸  æ–‡æ¡£é¡¹ç›®å·²å­˜åœ¨"
    }
'
"""

[tasks."docs:dev"]
description = "å¯åŠ¨æ–‡æ¡£å¼€å‘æœåŠ¡å™¨"
run = "cd docs && npm run dev"
depends = ["docs:install"]

[tasks."docs:build"]
description = "æ„å»ºæ–‡æ¡£é™æ€ç«™ç‚¹"
run = "cd docs && npm run build"
depends = ["docs:install"]

[tasks."docs:install"]
description = "å®‰è£…æ–‡æ¡£é¡¹ç›®ä¾èµ–"
run = """
nu -c '
    if ("docs/package.json" | path exists) {
        cd docs
        npm install
        cd ..
    } else {
        print "âŒ æ–‡æ¡£é¡¹ç›®æœªåˆå§‹åŒ–ï¼Œè¯·å…ˆè¿è¡Œ: mise run docs:init"
        exit 1
    }
'
"""

# ========== Chezmoi ä»»åŠ¡ï¼ˆæœªæ¥ä½¿ç”¨ï¼‰ ==========

[tasks."chezmoi:init"]
description = "ã€æœªæ¥ã€‘åˆå§‹åŒ– Chezmoiï¼ˆé›†æˆ Bitwardenï¼‰"
run = """
echo "âš ï¸  Chezmoi é›†æˆæš‚æœªå®ç°"
echo "è®¡åˆ’åŠŸèƒ½ï¼š"
echo "  - ä» Bitwarden è¯»å–æ•æ„Ÿé…ç½®"
echo "  - ç®¡ç†è·¨è®¾å¤‡çš„ dotfiles"
echo "  - æ”¯æŒæ¨¡æ¿åŒ–é…ç½®"
"""

[tasks."chezmoi:apply"]
description = "ã€æœªæ¥ã€‘åº”ç”¨ Chezmoi é…ç½®"
run = "echo 'æš‚æœªå®ç°ï¼šchezmoi apply'"

# ========================================
# ä»»åŠ¡åˆ«å
# ========================================
[alias]
# å¸¸ç”¨ä»»åŠ¡çš„ç®€çŸ­åˆ«å
i = "init"
s = "status"
u = "update"
c = "clean"
v = "verify"
